============================= test session starts =============================
platform win32 -- Python 3.11.14, pytest-9.0.2, pluggy-1.6.0 -- C:\Users\ljega\anaconda3\envs\permian-econ\python.exe
cachedir: .pytest_cache
rootdir: C:\Users\ljega\Downloads\GitHub\Permian Well Economics Engine
collecting ... collected 23 items

tests/test_well_economics.py::TestCashFlowStructure::test_month_zero_is_large_negative PASSED [  4%]
tests/test_well_economics.py::TestCashFlowStructure::test_cashflow_dataframe_has_required_columns PASSED [  8%]
tests/test_well_economics.py::TestCashFlowStructure::test_net_production_less_than_gross PASSED [ 13%]
tests/test_well_economics.py::TestCashFlowStructure::test_revenue_positive_when_producing PASSED [ 17%]
tests/test_well_economics.py::TestCashFlowStructure::test_taxes_are_fraction_of_revenue PASSED [ 21%]
tests/test_well_economics.py::TestCashFlowStructure::test_abandonment_cost_in_final_producing_month PASSED [ 26%]
tests/test_well_economics.py::TestCashFlowStructure::test_cumulative_cf_is_monotone_after_payback FAILED [ 30%]
tests/test_well_economics.py::TestFinancialMetrics::test_high_price_gives_positive_pv10 PASSED [ 34%]
tests/test_well_economics.py::TestFinancialMetrics::test_low_price_gives_negative_pv10 PASSED [ 39%]
tests/test_well_economics.py::TestFinancialMetrics::test_higher_price_gives_higher_pv10 PASSED [ 43%]
tests/test_well_economics.py::TestFinancialMetrics::test_irr_exists_at_high_price PASSED [ 47%]
tests/test_well_economics.py::TestFinancialMetrics::test_irr_none_at_very_low_price FAILED [ 52%]
tests/test_well_economics.py::TestFinancialMetrics::test_irr_in_realistic_permian_range_at_base_price PASSED [ 56%]
tests/test_well_economics.py::TestFinancialMetrics::test_payback_exists_at_high_price PASSED [ 60%]
tests/test_well_economics.py::TestFinancialMetrics::test_breakeven_wti_consistency PASSED [ 65%]
tests/test_well_economics.py::TestFinancialMetrics::test_target_breakeven_higher_than_zero_breakeven PASSED [ 69%]
tests/test_well_economics.py::TestFinancialMetrics::test_fd_cost_in_realistic_range PASSED [ 73%]
tests/test_well_economics.py::TestFinancialMetrics::test_npv_per_lateral_foot PASSED [ 78%]
tests/test_well_economics.py::TestSensitivityTable::test_sensitivity_table_built PASSED [ 82%]
tests/test_well_economics.py::TestSensitivityTable::test_sensitivity_table_correct_dimensions PASSED [ 86%]
tests/test_well_economics.py::TestSensitivityTable::test_higher_wti_gives_higher_pv10_in_sensitivity PASSED [ 91%]
tests/test_well_economics.py::TestSensitivityTable::test_lower_dc_gives_higher_pv10_in_sensitivity PASSED [ 95%]
tests/test_well_economics.py::TestSensitivityTable::test_sensitivity_skipped_when_flag_false PASSED [100%]

================================== FAILURES ===================================
_____ TestCashFlowStructure.test_cumulative_cf_is_monotone_after_payback ______

self = <tests.test_well_economics.TestCashFlowStructure object at 0x000001BE6031E5D0>

    def test_cumulative_cf_is_monotone_after_payback(self):
        """Once cumulative CF turns positive, it should stay positive."""
        df = CALC._build_cashflows(FORECAST, PRICE_100, MIX, COSTS)
        cum = df['cumulative_cf'].values
        positive_idx = np.where(cum > 0)[0]
        if len(positive_idx) > 0:
            first_positive = positive_idx[0]
            tail = cum[first_positive:]
>           assert np.all(np.diff(tail) >= -1.0), \
                "Cumulative CF declined after turning positive"
E           AssertionError: Cumulative CF declined after turning positive
E           assert np.False_
E            +  where np.False_ = <function all at 0x000001BE34225670>(array([470263.0063553 , 455121.80335338, 441082.57542331, 428023.74337371,\n       415841.35174808, 404445.94954995, 393760.11577499, 383716.47862624,\n       374256.11660557, 365327.25781429, 356884.2141888 , 348886.502348  ,\n       341298.11380788, 334086.90561161, 327224.08868921, 320683.79603654,\n       314442.716474  , 308479.78258775, 302775.90367453, 297313.73625334,\n       292077.48608512, 287052.73673769, 282226.30061082, 277586.08904198,\n       273120.9986849 , 268820.81181745, 264676.108615  , 260678.18973668,\n       256819.00782928, 253091.10676572, 249487.56761201, 246001.96046407,\n       242628.30141932, 239361.01405168, 236194.8948463 , 233125.08212432,\n       230147.02805094, 227256.47337348, 224449.42458199, 221722.13322393,\n       219071.07713821, 216492.94340264, 213984.61281401, 211543.14574136,\n       209165.76921203, 206849.86510608, 204592.95934901, 202392.7120051 ,\n       200246.90818444, 198153.44968621, 196110.3473093 , 194115.71376831,\n       192167.75715991, 190264.77492995, 188405.14829667, 186587.33709033,\n       184809.87497292, 183071.36500568, 181370.47553495, 179705.93636991,\n       178076.53522814, 176481.11442723, 174918.56780267, 173387.83783407...66210.2467361 ,\n        66043.81848013,  65878.3260873 ,  65713.76127067,  65550.11584327,\n        65387.38171659,  65225.55089911,  65064.61549476,  64904.56770156,\n        64745.39981014,  64587.1042024 ,  64429.6733501 ,  64273.09981354,\n        64117.37624024,  63962.49536366,  63808.45000191,  63655.23305652,\n        63502.83751118,  63351.2564306 ,  63200.48295928,  63050.51032033,\n        62901.33181439,  62752.94081848,  62605.33078488,  62458.49524008,\n        62312.42778368,  62167.12208739,  62022.57189398,  61878.77101624,\n        61735.71333607,  61593.39280341,  61451.80343535,  61310.93931515,\n        61170.79459134,  61031.36347679,  60892.64024784,  60754.61924337,\n        60617.29486401,  60480.6615712 ,  60344.71388645,  60209.44639043,\n        60074.85372221,  59940.93057847,  59807.67171267,  59675.07193434,\n        59543.12610828,  59411.82915382,  59281.17604411,  59151.1618054 ,\n        59021.78151627,  58893.03030702,  58764.90335893,  58637.39590359,\n        58510.50322226,  58384.22064518,  58258.54355095,  58133.46736589,\n        58008.98756343,  57885.09966347,  57761.79923179,  57639.08187947,\n        57516.94326229,  57395.37908013, -42725.61492354]) >= -1.0)
E            +    where <function all at 0x000001BE34225670> = np.all
E            +    and   array([470263.0063553 , 455121.80335338, 441082.57542331, 428023.74337371,\n       415841.35174808, 404445.94954995, 393760.11577499, 383716.47862624,\n       374256.11660557, 365327.25781429, 356884.2141888 , 348886.502348  ,\n       341298.11380788, 334086.90561161, 327224.08868921, 320683.79603654,\n       314442.716474  , 308479.78258775, 302775.90367453, 297313.73625334,\n       292077.48608512, 287052.73673769, 282226.30061082, 277586.08904198,\n       273120.9986849 , 268820.81181745, 264676.108615  , 260678.18973668,\n       256819.00782928, 253091.10676572, 249487.56761201, 246001.96046407,\n       242628.30141932, 239361.01405168, 236194.8948463 , 233125.08212432,\n       230147.02805094, 227256.47337348, 224449.42458199, 221722.13322393,\n       219071.07713821, 216492.94340264, 213984.61281401, 211543.14574136,\n       209165.76921203, 206849.86510608, 204592.95934901, 202392.7120051 ,\n       200246.90818444, 198153.44968621, 196110.3473093 , 194115.71376831,\n       192167.75715991, 190264.77492995, 188405.14829667, 186587.33709033,\n       184809.87497292, 183071.36500568, 181370.47553495, 179705.93636991,\n       178076.53522814, 176481.11442723, 174918.56780267, 173387.83783407...66210.2467361 ,\n        66043.81848013,  65878.3260873 ,  65713.76127067,  65550.11584327,\n        65387.38171659,  65225.55089911,  65064.61549476,  64904.56770156,\n        64745.39981014,  64587.1042024 ,  64429.6733501 ,  64273.09981354,\n        64117.37624024,  63962.49536366,  63808.45000191,  63655.23305652,\n        63502.83751118,  63351.2564306 ,  63200.48295928,  63050.51032033,\n        62901.33181439,  62752.94081848,  62605.33078488,  62458.49524008,\n        62312.42778368,  62167.12208739,  62022.57189398,  61878.77101624,\n        61735.71333607,  61593.39280341,  61451.80343535,  61310.93931515,\n        61170.79459134,  61031.36347679,  60892.64024784,  60754.61924337,\n        60617.29486401,  60480.6615712 ,  60344.71388645,  60209.44639043,\n        60074.85372221,  59940.93057847,  59807.67171267,  59675.07193434,\n        59543.12610828,  59411.82915382,  59281.17604411,  59151.1618054 ,\n        59021.78151627,  58893.03030702,  58764.90335893,  58637.39590359,\n        58510.50322226,  58384.22064518,  58258.54355095,  58133.46736589,\n        58008.98756343,  57885.09966347,  57761.79923179,  57639.08187947,\n        57516.94326229,  57395.37908013, -42725.61492354]) = <function diff at 0x000001BE3433AB30>(array([   56295.29269274,   526558.29904804,   981680.10240142,\n        1422762.67782473,  1850786.42119844,  2266627.77294652,\n        2671073.72249647,  3064833.83827146,  3448550.31689769,\n        3822806.43350327,  4188133.69131756,  4545017.90550636,\n        4893904.40785436,  5235202.52166224,  5569289.42727386,\n        5896513.51596307,  6217197.31199961,  6531640.02847361,\n        6840119.81106137,  7142895.7147359 ,  7440209.45098924,\n        7732286.93707436,  8019339.67381205,  8301565.97442287,\n        8579152.06346485,  8852273.06214975,  9121093.8739672 ,\n        9385769.9825822 ,  9646448.17231887,  9903267.18014815,\n       10156358.28691387, 10405845.85452588, 10651847.81498995,\n       10894476.11640927, 11133837.13046095, 11370032.02530724,\n       11603157.10743156, 11833304.1354825 , 12060560.60885597,\n       12285010.03343796, 12506732.16666189, 12725803.2438001 ,\n       12942296.18720273, 13156280.80001674, 13367823.9457581 ,\n       13576989.71497013, 13783839.58007621, 13988432.53942523,\n       14190825.25143033, 14391072.15961477, 14589225.60930099,\n       14785335.95661028, 14979451.67037859, 15171619.4275385 ,\n       15361884.20246845, 15550289.35076512, 1...1491593, 39832677.88261749, 39897423.28242763,\n       39962010.38663003, 40026440.05998012, 40090713.15979366,\n       40154830.5360339 , 40218793.03139756, 40282601.48139947,\n       40346256.71445598, 40409759.55196717, 40473110.80839777,\n       40536311.29135705, 40599361.80167738, 40662263.13349177,\n       40725016.07431025, 40787621.40509513, 40850079.90033521,\n       40912392.32811888, 40974559.45020627, 41036582.02210025,\n       41098460.79311649, 41160196.50645255, 41221789.89925596,\n       41283241.70269131, 41344552.64200646, 41405723.43659779,\n       41466754.80007458, 41527647.44032242, 41588402.05956579,\n       41649019.3544298 , 41709500.016001  , 41769844.72988745,\n       41830054.17627788, 41890129.03000009, 41950069.96057856,\n       42009877.63229124, 42069552.70422558, 42129095.83033386,\n       42188507.65948768, 42247788.83553179, 42306939.99733719,\n       42365961.77885346, 42424854.80916048, 42483619.71251941,\n       42542257.108423  , 42600767.61164527, 42659151.83229045,\n       42717410.37584139, 42775543.84320728, 42833552.83077072,\n       42891437.93043418, 42949199.72966597, 43006838.81154545,\n       43064355.75480773, 43121751.13388786, 43079025.51896432]))
E            +      where <function diff at 0x000001BE3433AB30> = np.diff

tests\test_well_economics.py:104: AssertionError
____________ TestFinancialMetrics.test_irr_none_at_very_low_price _____________

self = <tests.test_well_economics.TestFinancialMetrics object at 0x000001BE6032C310>

    def test_irr_none_at_very_low_price(self):
        result = CALC.run(FORECAST, PRICE_40, MIX, COSTS, build_sensitivity=False)
>       assert result.irr is None, \
            f"IRR should be None at $40 WTI (well never pays back), got {result.irr}"
E       AssertionError: IRR should be None at $40 WTI (well never pays back), got 0.0836895370743374
E       assert 0.0836895370743374 is None
E        +  where 0.0836895370743374 = WellEconomicsOutput(pv10=-512832.8917999433, irr=0.0836895370743374, payback_months=99.0, breakeven_wti_zero_irr=nan, breakeven_wti_target=nan, target_irr=0.15, total_revenue=28908137.473432038, total_loe=10627603.283270113, total_taxes=1907937.0732465147, total_gc=3215661.1491445396, total_capex=7600000.0, total_net_cf=5309474.30044944, npv_per_lateral_foot=-51.28328917999433, fd_cost=6.584228648393607, cash_on_cash=1.698615039532821, monthly_cash_flows=array([-7500000.        ,   228666.79381188,   212903.28553644,\n         199464.67214447,   187851.85142776,   177701.51069801,\n         168742.44956216,   160767.8416349 ,   153617.01154311,\n         147163.10943971,   141304.56084053,   135959.00230756,\n         131058.89499346,   126548.29584316,   122380.44335957,\n         118515.92671656,   114921.27934383,   111567.88587921,\n         108431.12353959,   105489.68098495,   102725.0130765 ,\n         100120.9007521 ,    97663.09298846,    95339.01343288,\n          93137.51840276,    91048.69600077,    89063.6983763 ,\n          87174.60088841,    85374.28324044,    83656.3286663 ,\n          82014.93803148,    80444.85632188,    78941.30947363,\n          77499.94987588,    76116....4564e+06,  5.18610074e+06,  5.19951987e+06,\n        5.21290321e+06,  5.22625094e+06,  5.23956323e+06,  5.25284025e+06,\n        5.26608217e+06,  5.27928916e+06,  5.29246139e+06,  5.30559903e+06,\n        5.31870223e+06,  5.33177118e+06,  5.34480602e+06,  5.35780691e+06,\n        5.37077403e+06,  5.38370753e+06,  5.39660757e+06,  5.30947430e+06]), cashflow_df=     month_index  gross_oil_bbl  ...           ncf  cumulative_cf\n0              0   14131.696429  ... -7.500000e+06  -7.500000e+06\n1              1   13075.458117  ...  2.286668e+05  -7.271333e+06\n2              2   12189.577116  ...  2.129033e+05  -7.058430e+06\n3              3   11434.351054  ...  1.994647e+05  -6.858965e+06\n4              4   10781.731277  ...  1.878519e+05  -6.671113e+06\n..           ...            ...  ...           ...            ...\n355          355     955.420169  ...  1.300090e+04   5.357807e+06\n356          356     953.521801  ...  1.296712e+04   5.370774e+06\n357          357     951.632385  ...  1.293350e+04   5.383708e+06\n358          358     949.751856  ...  1.290004e+04   5.396608e+06\n359          359     947.880147  ... -8.713327e+04   5.309474e+06\n\n[360 rows x 24 columns], sensitivity_table=None).irr

tests\test_well_economics.py:136: AssertionError
=========================== short test summary info ===========================
FAILED tests/test_well_economics.py::TestCashFlowStructure::test_cumulative_cf_is_monotone_after_payback
FAILED tests/test_well_economics.py::TestFinancialMetrics::test_irr_none_at_very_low_price
======================== 2 failed, 21 passed in 2.75s =========================
